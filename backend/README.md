# BeanFlow-CRA Backend

**CRA ç¨åŠ¡æ–‡æ¡£å¤„ç†ä¸æ™ºèƒ½é—®ç­”ç³»ç»Ÿ**

å®Œæ•´çš„ç¨åŠ¡çŸ¥è¯†å¤„ç†è§£å†³æ–¹æ¡ˆï¼ŒåŒ…å«ä¸¤ä¸ªæ ¸å¿ƒéƒ¨åˆ†ï¼š

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### Part 1: Skill ç”Ÿæˆ Pipeline âœ… (å·²å®ç°)

**ç¦»çº¿æ–‡æ¡£å¤„ç†å·¥å…·** - å°† CRA ç¨åŠ¡ PDF è½¬æ¢ä¸ºç»“æ„åŒ–çš„ Skill æ–‡ä»¶

```
PDF æ–‡æ¡£ â†’ å¤šé˜¶æ®µ Pipeline â†’ Skill Markdown æ–‡ä»¶
```

**ç‰¹ç‚¹**:
- ğŸ¤– å¤šé˜¶æ®µæµæ°´çº¿ï¼ˆ6 ä¸ªç‹¬ç«‹é˜¶æ®µï¼‰
- ğŸ’¾ æ™ºèƒ½ç¼“å­˜æœºåˆ¶
- â¸ï¸ æ–­ç‚¹ç»­ä¼ æ”¯æŒ
- ğŸ“Š å®æ—¶è¿›åº¦è¿½è¸ª

**ç”¨é€”**: ç”Ÿæˆ AI Agent çš„çŸ¥è¯†åº“æ–‡æ¡£

---

### Part 2: FastAPI é—®ç­”æœåŠ¡ ğŸš§ (è§„åˆ’ä¸­)

**åœ¨çº¿ API æœåŠ¡** - åŸºäºç”Ÿæˆçš„ Skill æ–‡ä»¶æä¾›å®æ—¶ç¨åŠ¡é—®ç­”

```
ç”¨æˆ·é—®é¢˜ â†’ FastAPI â†’ åŠ è½½ Skills â†’ Claude/GLM-4 â†’ æ™ºèƒ½å›ç­”
```

**è§„åˆ’ç‰¹æ€§**:
- ğŸŒ REST API æ¥å£
- ğŸ“š åŠ¨æ€ Skill åŠ è½½
- ğŸ¤– å¤š LLM æ”¯æŒï¼ˆClaude, GLM-4ï¼‰
- ğŸ’¬ ä¼šè¯ç®¡ç†
- ğŸ” ä¸Šä¸‹æ–‡æ£€ç´¢

**ç”¨é€”**: ä¸ºå‰ç«¯æä¾›å®æ—¶ç¨åŠ¡å’¨è¯¢ API

---

## âœ¨ Part 1 ç‰¹æ€§ï¼ˆSkill ç”Ÿæˆï¼‰

- ğŸ¤– **å¤šé˜¶æ®µæµæ°´çº¿**: 5 ä¸ªç‹¬ç«‹å¯å¤ç”¨çš„å¤„ç†é˜¶æ®µ
- ğŸ’¾ **æ™ºèƒ½ç¼“å­˜**: è‡ªåŠ¨ä¿å­˜ä¸­é—´ç»“æœï¼Œé¿å…é‡å¤å¤„ç†
- â¸ï¸ **æ–­ç‚¹ç»­ä¼ **: å¤„ç†ä¸­æ–­åå¯ä»ä¸Šæ¬¡ä½ç½®ç»§ç»­
- ğŸ”„ **å¤±è´¥é‡è¯•**: å•ç‹¬é‡è¯•å¤±è´¥çš„å†…å®¹å—
- ğŸ“Š **è¿›åº¦è¿½è¸ª**: å®æ—¶æ˜¾ç¤ºå¤„ç†è¿›åº¦å’Œ ETA
- ğŸ¯ **æ™ºèƒ½åˆ†ç±»**: å¤šä¿¡å·å†…å®¹åˆ†ç±»ç®—æ³•
- ğŸ“– **ç« èŠ‚æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«æ–‡æ¡£ç« èŠ‚ç»“æ„

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒé…ç½®

```bash
cd backend

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
uv venv .venv
source .venv/bin/activate  # macOS/Linux

# å®‰è£…ä¾èµ–
uv sync
```

### 2. å®‰è£… LLM CLI (å¯é€‰)

å¦‚æœéœ€è¦ AI å¢å¼ºåŠŸèƒ½ï¼Œå®‰è£…ä»¥ä¸‹ä»»ä¸€ CLIï¼š

```bash
# Claude Code (æ¨è)
# å·²åŒ…å«åœ¨ Claude Code è®¢é˜…ä¸­

# æˆ– Gemini CLI
pip install google-generativeai

# æˆ– OpenAI Codex
pip install openai
```

### 3. åŸºæœ¬ä½¿ç”¨

```bash
# å¿«é€Ÿæµ‹è¯•ï¼ˆå‰ 10 é¡µï¼Œæ—  AI å¢å¼ºï¼‰
uv run python generate_skill.py --pdf ../mvp/pdf/t4012-24e.pdf --no-ai

# å®Œæ•´å¤„ç†ï¼ˆæ‰€æœ‰ 151 é¡µ + AI å¢å¼ºï¼‰
uv run python generate_skill.py \
  --pdf ../mvp/pdf/t4012-24e.pdf \
  --local-codex \
  --full

# å¤„ç†ä¸­æ–­åè‡ªåŠ¨ç»­ä¼ 
uv run python generate_skill.py \
  --pdf ../mvp/pdf/t4012-24e.pdf \
  --local-codex \
  --full
# è‡ªåŠ¨ä»ä¸Šæ¬¡ä¸­æ–­çš„ chunk ç»§ç»­
```

## ğŸ“ æ¶æ„æ¦‚è§ˆ

### å¤šé˜¶æ®µ Pipeline

ç³»ç»Ÿé‡‡ç”¨ **6 é˜¶æ®µæµæ°´çº¿æ¶æ„**ï¼Œæ¯ä¸ªé˜¶æ®µç‹¬ç«‹è¿è¡Œï¼Œç»“æœç¼“å­˜å¯å¤ç”¨ï¼š

```
PDF æ–‡ä»¶
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: PDF æå– (cached)                               â”‚
â”‚ - æå–æ–‡æœ¬å†…å®¹                                            â”‚
â”‚ - ä¿å­˜åˆ° cache/extraction_<hash>.json                   â”‚
â”‚ - æ—¶é—´: 30ç§’ - 2åˆ†é’Ÿ                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 2: å†…å®¹åˆ†ç±» (cached)                               â”‚
â”‚ - æ™ºèƒ½å¤šä¿¡å·åˆ†ç±»ç®—æ³•                                      â”‚
â”‚ - ä¿å­˜åˆ° cache/classification_<hash>.json               â”‚
â”‚ - æ—¶é—´: < 5ç§’                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 3: å†…å®¹åˆ†å— (cached)                               â”‚
â”‚ - ç« èŠ‚æ£€æµ‹ + æ™ºèƒ½åˆ†å—                                     â”‚
â”‚ - ä¿å­˜åˆ° cache/chunks_<hash>.json                       â”‚
â”‚ - æ—¶é—´: < 10ç§’                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 4: AI å¢å¼º (resumable) â­                          â”‚
â”‚ - é€ä¸ª chunk å¢å¼ºå¹¶ç«‹å³ä¿å­˜                               â”‚
â”‚ - ä¿å­˜åˆ° cache/enhanced_chunks_<hash>/                  â”‚
â”‚ - æ”¯æŒæ–­ç‚¹ç»­ä¼ å’Œå¤±è´¥é‡è¯•                                   â”‚
â”‚ - æ—¶é—´: 5-8 åˆ†é’Ÿ/chunk (151é¡µçº¦7-11å°æ—¶)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 5: ç”Ÿæˆ Skill ç›®å½•                                 â”‚
â”‚ - ç»„è£…æœ€ç»ˆç›®å½•ç»“æ„                                         â”‚
â”‚ - è¾“å‡ºåˆ° skills_output/<skill-id>/                      â”‚
â”‚ - æ—¶é—´: < 5ç§’                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 6: SKILL.md å¢å¼º (optional)                        â”‚
â”‚ - ç”Ÿæˆé«˜è´¨é‡ SKILL.md ç´¢å¼•                                â”‚
â”‚ - æ—¶é—´: 3-5 åˆ†é’Ÿ                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
æœ€ç»ˆè¾“å‡ºï¼šSkill ç›®å½•
```

### å…³é”®ä¼˜åŠ¿

**ä¼ ç»Ÿå•ä½“æ¶æ„**ï¼š
```
âŒ 415åˆ†é’Ÿè¿è¡Œä¸­æ–­ = å…¨éƒ¨é‡æ¥
âŒ æ— ä¸­é—´ç»“æœä¿å­˜
âŒ éš¾ä»¥è°ƒè¯•å’Œä¼˜åŒ–
```

**æ–° Pipeline æ¶æ„**ï¼š
```
âœ… ä»»æ„é˜¶æ®µå¯å•ç‹¬è¿è¡Œ
âœ… ä¸­æ–­åä»æ–­ç‚¹ç»§ç»­
âœ… ç¼“å­˜ç»“æœå¯å¤ç”¨
âœ… æ¸…æ™°çš„é”™è¯¯å®šä½
```

## ğŸ“– ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: ç»Ÿä¸€å…¥å£å¤„ç†

**æœ€å¸¸ç”¨æ–¹å¼** - ä½¿ç”¨ `generate_skill.py` ä¸€é”®å¤„ç†ï¼š

```bash
# å¤„ç†å®Œæ•´ PDFï¼ˆè‡ªåŠ¨è¿è¡Œæ‰€æœ‰é˜¶æ®µï¼‰
uv run python generate_skill.py \
  --pdf ../mvp/pdf/t4012-24e.pdf \
  --local-codex \
  --full \
  --enhance-skill
```

**ç‰¹ç‚¹**ï¼š
- âœ… è‡ªåŠ¨æ£€æµ‹ç¼“å­˜ï¼Œè·³è¿‡å·²å®Œæˆé˜¶æ®µ
- âœ… è‡ªåŠ¨ç»­ä¼ ä¸­æ–­çš„ AI å¢å¼º
- âœ… ç”¨æˆ·æ— éœ€äº†è§£å†…éƒ¨ç»†èŠ‚

### åœºæ™¯ 2: åˆ†é˜¶æ®µæ‰‹åŠ¨è¿è¡Œ

**è°ƒè¯•/ä¼˜åŒ–æ—¶** - æ‰‹åŠ¨æ§åˆ¶æ¯ä¸ªé˜¶æ®µï¼š

```bash
# Stage 1: æå– PDF
uv run python stage1_extract_pdf.py --pdf ../mvp/pdf/t4012-24e.pdf --full

# Stage 2: åˆ†ç±»å†…å®¹
uv run python stage2_classify_content.py --extraction-id abc123

# Stage 3: åˆ†å—
uv run python stage3_chunk_content.py --extraction-id abc123

# Stage 4: AI å¢å¼ºï¼ˆå¯éšæ—¶ä¸­æ–­ï¼ŒCtrl+Cï¼‰
uv run python stage4_enhance_chunks.py --chunks-id abc123 --provider codex

# Stage 4 ä¸­æ–­åç»­ä¼ 
uv run python stage4_enhance_chunks.py --chunks-id abc123 --resume

# Stage 5: ç”Ÿæˆ Skill
uv run python stage5_generate_skill.py --enhanced-id abc123
```

**é€‚ç”¨äº**ï¼š
- ğŸ”§ è°ƒè¯•ç‰¹å®šé˜¶æ®µé—®é¢˜
- ğŸ¯ æµ‹è¯•ä¸åŒ LLM provider
- ğŸ“Š æ€§èƒ½åˆ†æå’Œä¼˜åŒ–

### åœºæ™¯ 3: åªæå–æ–‡æœ¬ï¼ˆæ—  AIï¼‰

```bash
# å¿«é€Ÿæå–å¹¶ç”ŸæˆåŸºç¡€ Skillï¼ˆæ—  AI å¢å¼ºï¼‰
uv run python generate_skill.py \
  --pdf ../mvp/pdf/t4012-24e.pdf \
  --no-ai \
  --full
```

**æ—¶é—´**: çº¦ 2-3 åˆ†é’Ÿï¼ˆ151é¡µï¼‰

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ generate_skill.py              # ç»Ÿä¸€å…¥å£ - Pipeline ç¼–æ’å™¨
â”œâ”€â”€ stage1_extract_pdf.py          # Stage 1: PDF æå–
â”œâ”€â”€ stage2_classify_content.py     # Stage 2: å†…å®¹åˆ†ç±»
â”œâ”€â”€ stage3_chunk_content.py        # Stage 3: å†…å®¹åˆ†å—
â”œâ”€â”€ stage4_enhance_chunks.py       # Stage 4: AI å¢å¼º
â”œâ”€â”€ stage5_generate_skill.py       # Stage 5: Skill ç”Ÿæˆ
â”œâ”€â”€ enhance_skill.py               # Stage 6: SKILL.md å¢å¼º
â”‚
â”œâ”€â”€ cache/                         # ç¼“å­˜ç›®å½•ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”‚   â”œâ”€â”€ README.md                  # ç¼“å­˜æ ¼å¼è¯´æ˜
â”‚   â”œâ”€â”€ extraction_*.json          # Stage 1 ç¼“å­˜
â”‚   â”œâ”€â”€ classification_*.json      # Stage 2 ç¼“å­˜
â”‚   â”œâ”€â”€ chunks_*.json              # Stage 3 ç¼“å­˜
â”‚   â””â”€â”€ enhanced_chunks_*/         # Stage 4 ç¼“å­˜
â”‚       â”œâ”€â”€ progress.json          # è¿›åº¦è¿½è¸ª
â”‚       â””â”€â”€ chunk-*.json           # å¢å¼ºåçš„å—
â”‚
â”œâ”€â”€ skills_output/                 # æœ€ç»ˆè¾“å‡ºç›®å½•
â”‚   â””â”€â”€ <skill-id>/
â”‚       â”œâ”€â”€ SKILL.md               # ç´¢å¼•æ–‡ä»¶
â”‚       â”œâ”€â”€ references/            # å‚è€ƒæ–‡æ¡£
â”‚       â”‚   â”œâ”€â”€ index.md
â”‚       â”‚   â””â”€â”€ *.md
â”‚       â””â”€â”€ raw/                   # åŸå§‹æå–æ–‡æœ¬
â”‚           â””â”€â”€ full-extract.txt
â”‚
â”œâ”€â”€ app/
â”‚   â””â”€â”€ document_processor/        # æ ¸å¿ƒå¤„ç†æ¨¡å—
â”‚       â”œâ”€â”€ pipeline_manager.py    # Pipeline + Cache ç®¡ç†
â”‚       â”œâ”€â”€ pdf_extractor.py       # PDF æå–
â”‚       â”œâ”€â”€ content_classifier.py  # å†…å®¹åˆ†ç±»
â”‚       â”œâ”€â”€ skill_generator.py     # Skill ç”Ÿæˆ
â”‚       â”œâ”€â”€ skill_enhancer.py      # SKILL.md å¢å¼º
â”‚       â””â”€â”€ llm_cli_providers.py   # LLM Provider æŠ½è±¡
â”‚
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ PIPELINE_ARCHITECTURE.md   # æ¶æ„è¯¦ç»†æ–‡æ¡£
â”‚   â””â”€â”€ SKILL_ENHANCEMENT.md       # SKILL.md å¢å¼ºè¯´æ˜
â”‚
â””â”€â”€ pyproject.toml                 # Python ä¾èµ–é…ç½®
```

## ğŸ”§ å‘½ä»¤è¡Œå‚æ•°

### `generate_skill.py` (æ¨èä½¿ç”¨)

```bash
# å¿…éœ€å‚æ•°
--pdf PATH                 # PDF æ–‡ä»¶è·¯å¾„

# PDF æå–é€‰é¡¹
--full                     # å¤„ç†å®Œæ•´æ–‡æ¡£ï¼ˆé»˜è®¤åªå¤„ç†å‰10é¡µï¼‰
--max-pages N              # å¤„ç†å‰ N é¡µï¼ˆé»˜è®¤: 10ï¼‰
--force-extract            # å¼ºåˆ¶é‡æ–°æå–ï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰

# LLM Provider é€‰é¡¹ï¼ˆå¿…é€‰å…¶ä¸€ï¼‰
--no-ai                    # è·³è¿‡ AI å¢å¼º
--local-claude             # ä½¿ç”¨ Claude CLI
--local-gemini             # ä½¿ç”¨ Gemini CLI
--local-codex              # ä½¿ç”¨ Codex CLI

# å¢å¼ºé€‰é¡¹
--enhance-skill            # å¢å¼º SKILL.mdï¼ˆé¢å¤–3-5åˆ†é’Ÿï¼‰

# è¾“å‡ºé€‰é¡¹
--output-dir DIR           # è¾“å‡ºç›®å½•ï¼ˆé»˜è®¤: skills_outputï¼‰
--cache-dir DIR            # ç¼“å­˜ç›®å½•ï¼ˆé»˜è®¤: backend/cacheï¼‰
```

### Stage è„šæœ¬å‚æ•°

æ¯ä¸ª stage è„šæœ¬æ”¯æŒ `--help` æŸ¥çœ‹å®Œæ•´å‚æ•°ï¼š

```bash
uv run python stage1_extract_pdf.py --help
uv run python stage4_enhance_chunks.py --help
```

## ğŸ’¾ ç¼“å­˜æœºåˆ¶

### å·¥ä½œåŸç†

1. **PDF Hash**: åŸºäº PDF å†…å®¹è®¡ç®— SHA256 å“ˆå¸Œï¼ˆå‰16ä½ï¼‰
2. **è‡ªåŠ¨æ£€æµ‹**: è¿è¡Œæ—¶è‡ªåŠ¨æ£€æµ‹å·²æœ‰ç¼“å­˜
3. **è·³è¿‡å·²å®Œæˆ**: å·²ç¼“å­˜çš„é˜¶æ®µè‡ªåŠ¨è·³è¿‡
4. **å¤±æ•ˆç­–ç•¥**: PDF å†…å®¹æ”¹å˜ â†’ æ–° Hash â†’ é‡æ–°å¤„ç†

### ç¼“å­˜ä½ç½®

```
backend/cache/
â”œâ”€â”€ extraction_abc123.json          # ~1.5 MB (151é¡µPDF)
â”œâ”€â”€ classification_abc123.json      # ~10 KB
â”œâ”€â”€ chunks_abc123.json              # ~1.5 MB
â””â”€â”€ enhanced_chunks_abc123/         # ~15 MB
    â”œâ”€â”€ progress.json               # è¿›åº¦è¿½è¸ª
    â”œâ”€â”€ chunk-001.json              # ~180 KB
    â”œâ”€â”€ chunk-002.json
    â””â”€â”€ ...
```

**æ€»å¤§å°**: çº¦ 18 MB / 151é¡µPDF

### ç®¡ç†ç¼“å­˜

```bash
# æŸ¥çœ‹ç¼“å­˜å¤§å°
du -sh backend/cache

# æ¸…ç†æ—§ç¼“å­˜ï¼ˆ7å¤©å‰ï¼‰
python -c "from app.document_processor.pipeline_manager import CacheManager; \
           CacheManager().clean_cache(older_than_days=7)"

# åˆ é™¤ç‰¹å®š PDF çš„ç¼“å­˜
python -c "from app.document_processor.pipeline_manager import CacheManager; \
           CacheManager().clean_cache(content_hash='abc123')"
```

## ğŸ”„ æ–­ç‚¹ç»­ä¼ 

### Stage 4 æ–­ç‚¹ç»­ä¼ 

Stage 4 (AI å¢å¼º) æ˜¯æœ€è€—æ—¶çš„é˜¶æ®µï¼Œæ”¯æŒå®Œæ•´çš„æ–­ç‚¹ç»­ä¼ ï¼š

**åœºæ™¯**: å¤„ç† 40/83 chunks æ—¶ä¸­æ–­

```bash
# ç¬¬ä¸€æ¬¡è¿è¡Œï¼ˆå¤„ç†åˆ° 40 ä¸ª chunk åä¸­æ–­ï¼‰
uv run python stage4_enhance_chunks.py \
  --chunks-id abc123 \
  --provider codex
# ... å¤„ç†ä¸­ ... Ctrl+C ä¸­æ–­

# è‡ªåŠ¨ç»­ä¼ ï¼ˆä»ç¬¬ 41 ä¸ª chunk å¼€å§‹ï¼‰
uv run python stage4_enhance_chunks.py \
  --chunks-id abc123 \
  --resume
```

**è¿›åº¦æ–‡ä»¶** `cache/enhanced_chunks_abc123/progress.json`:
```json
{
  "total_chunks": 83,
  "completed_chunks": 40,
  "failed_chunks": [15, 23],
  "start_time": "2025-11-04T10:05:00",
  "last_update": "2025-11-04T13:30:00",
  "estimated_remaining": "180 minutes",
  "provider": "codex"
}
```

### é‡è¯•å¤±è´¥çš„ Chunks

```bash
# åªé‡è¯•å¤±è´¥çš„ chunks (15, 23)
uv run python stage4_enhance_chunks.py \
  --chunks-id abc123 \
  --retry-failed
```

## ğŸ“Š æ€§èƒ½æ•°æ®

### å¤„ç†æ—¶é—´ä¼°ç®—ï¼ˆ151é¡µ PDFï¼‰

| é˜¶æ®µ | æ—¶é—´ | å¯è·³è¿‡ |
|------|------|--------|
| Stage 1: PDF æå– | 30ç§’ - 2åˆ†é’Ÿ | âœ… ç¼“å­˜å |
| Stage 2: å†…å®¹åˆ†ç±» | < 5ç§’ | âœ… ç¼“å­˜å |
| Stage 3: å†…å®¹åˆ†å— | < 10ç§’ | âœ… ç¼“å­˜å |
| **Stage 4: AI å¢å¼º** | **7-11 å°æ—¶** | âœ… æ–­ç‚¹ç»­ä¼  |
| Stage 5: Skill ç”Ÿæˆ | < 5ç§’ | - |
| Stage 6: SKILL å¢å¼º | 3-5 åˆ†é’Ÿ | å¯é€‰ |
| **æ€»è®¡** | **7-11 å°æ—¶** | - |

**Stage 4 è¯¦ç»†**:
- 83 chunks Ã— 5-8 åˆ†é’Ÿ/chunk
- å¯éšæ—¶ä¸­æ–­ï¼Œç»­ä¼ æ—¶è·³è¿‡å·²å®Œæˆ

### ç¼“å­˜æ”¶ç›Š

**é¦–æ¬¡è¿è¡Œ**: 7-11 å°æ—¶
**ç¬¬äºŒæ¬¡è¿è¡Œï¼ˆä¿®æ”¹ promptï¼‰**: 7-11 å°æ—¶ï¼ˆStage 4 å¯é‡ç”¨ Stage 1-3 ç¼“å­˜ï¼‰
**ç¬¬ä¸‰æ¬¡è¿è¡Œï¼ˆåŒ PDFï¼‰**: < 5ç§’ï¼ˆå…¨éƒ¨è·³è¿‡ï¼‰

## ğŸ› æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**1. Provider ä¸å¯ç”¨**

```bash
âŒ Error: Provider 'codex' not available
```

**è§£å†³**:
```bash
# æ£€æŸ¥ CLI æ˜¯å¦å®‰è£…
which claude  # æˆ– gemini-cli / openai

# æ£€æŸ¥æ˜¯å¦åœ¨ PATH ä¸­
echo $PATH
```

**2. ç¼“å­˜ä¸åŒ¹é…**

```bash
âš ï¸  Cached extraction found but page limit differs
```

**è§£å†³**: è¿™æ˜¯æ­£å¸¸è¡Œä¸ºï¼Œä¼šè‡ªåŠ¨é‡æ–°æå–

**3. Enhancement è¶…æ—¶**

```bash
â¸ï¸ Enhancement interrupted
```

**è§£å†³**: ä½¿ç”¨ `--resume` ç»­ä¼ 
```bash
uv run python stage4_enhance_chunks.py --chunks-id <hash> --resume
```

**4. ç£ç›˜ç©ºé—´ä¸è¶³**

```bash
# æ¸…ç†æ—§ç¼“å­˜
python -c "from app.document_processor.pipeline_manager import CacheManager; \
           CacheManager().clean_cache(older_than_days=7)"
```

### è·å–å¸®åŠ©

- æŸ¥çœ‹è¯¦ç»†æ—¥å¿—: è„šæœ¬è¾“å‡ºä¸­åŒ…å«å®Œæ•´çš„é”™è¯¯ä¿¡æ¯
- æ£€æŸ¥ç¼“å­˜çŠ¶æ€: `ls -lh backend/cache/`
- æŸ¥çœ‹è¿›åº¦æ–‡ä»¶: `cat backend/cache/enhanced_chunks_*/progress.json`
- æ–‡æ¡£: `backend/docs/PIPELINE_ARCHITECTURE.md`

---

## ğŸš§ Part 2: FastAPI é—®ç­”æœåŠ¡ï¼ˆè§„åˆ’ï¼‰

### æ¶æ„è®¾è®¡

**é¢„æœŸç›®å½•ç»“æ„**:
```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py                    # FastAPI åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ api/                       # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ chat.py               # é—®ç­”æ¥å£
â”‚   â”‚   â”œâ”€â”€ skills.py             # Skill ç®¡ç†
â”‚   â”‚   â””â”€â”€ health.py             # å¥åº·æ£€æŸ¥
â”‚   â”œâ”€â”€ services/                  # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ skill_loader.py       # Skill æ–‡ä»¶åŠ è½½
â”‚   â”‚   â”œâ”€â”€ llm_service.py        # LLM è°ƒç”¨æœåŠ¡
â”‚   â”‚   â””â”€â”€ context_retrieval.py  # ä¸Šä¸‹æ–‡æ£€ç´¢
â”‚   â”œâ”€â”€ models/                    # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ chat.py               # èŠå¤©ç›¸å…³æ¨¡å‹
â”‚   â”‚   â””â”€â”€ skill.py              # Skill æ•°æ®æ¨¡å‹
â”‚   â””â”€â”€ utils/                     # å·¥å…·å‡½æ•°
â”‚       â””â”€â”€ markdown_parser.py     # Markdown è§£æ
â”‚
â””â”€â”€ document_processor/            # âœ… å·²å®ç°ï¼ˆSkill ç”Ÿæˆï¼‰
```

### æ ¸å¿ƒåŠŸèƒ½

#### 1. Skill åŠ è½½æœåŠ¡

```python
# services/skill_loader.py
class SkillLoader:
    """åŠ è½½å’Œç´¢å¼• Skill æ–‡ä»¶"""

    def load_skills(self, skills_dir: Path):
        """ä» skills_output/ åŠ è½½æ‰€æœ‰ Skills"""

    def search_skills(self, query: str):
        """æœç´¢ç›¸å…³çš„ Skill"""

    def get_skill_content(self, skill_id: str):
        """è·å–ç‰¹å®š Skill çš„å®Œæ•´å†…å®¹"""
```

#### 2. LLM æœåŠ¡

```python
# services/llm_service.py
class LLMService:
    """LLM è°ƒç”¨æŠ½è±¡å±‚"""

    def chat(self, messages: List[dict], context: str):
        """å‘é€é—®é¢˜ç»™ LLMï¼Œé™„å¸¦ Skill ä¸Šä¸‹æ–‡"""

    def switch_provider(self, provider: str):
        """åˆ‡æ¢ LLM provider (Claude/GLM-4)"""
```

#### 3. API ç«¯ç‚¹

```python
# api/chat.py
@router.post("/chat")
async def chat(request: ChatRequest):
    """
    ç¨åŠ¡é—®ç­”æ¥å£

    Request:
        {
            "question": "å¦‚ä½•ç”³æŠ¥é›‡ä½£æ”¶å…¥ï¼Ÿ",
            "session_id": "optional-session-id",
            "provider": "claude"  # or "glm4"
        }

    Response:
        {
            "answer": "...",
            "sources": ["skill-1", "skill-2"],
            "session_id": "..."
        }
    """
```

### å·¥ä½œæµç¨‹

```
1. ç”¨æˆ·æé—®
   â†“
2. æ£€ç´¢ç›¸å…³ Skills
   â”œâ”€ åŸºäºå…³é”®è¯åŒ¹é…
   â”œâ”€ åŸºäºåˆ†ç±»æ ‡ç­¾
   â””â”€ åŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦ï¼ˆå¯é€‰ï¼‰
   â†“
3. åŠ è½½ Skill å†…å®¹ä½œä¸ºä¸Šä¸‹æ–‡
   â†“
4. è°ƒç”¨ LLM (Claude/GLM-4)
   â”œâ”€ System prompt: ç¨åŠ¡ä¸“å®¶è§’è‰²
   â”œâ”€ Context: ç›¸å…³ Skill å†…å®¹
   â””â”€ User question: ç”¨æˆ·é—®é¢˜
   â†“
5. è¿”å›å›ç­” + æ¥æºå¼•ç”¨
```

### æŠ€æœ¯é€‰å‹

| ç»„ä»¶ | æŠ€æœ¯ | åŸå›  |
|------|------|------|
| Web æ¡†æ¶ | FastAPI | å¼‚æ­¥æ”¯æŒï¼Œè‡ªåŠ¨æ–‡æ¡£ |
| LLM | Claude Sonnet 4.5 | é«˜è´¨é‡æ¨ç†ï¼Œé•¿ä¸Šä¸‹æ–‡ |
| LLM (å¤‡é€‰) | GLM-4 | ä¸­æ–‡ä¼˜åŒ–ï¼Œæˆæœ¬è¾ƒä½ |
| å‘é‡æ•°æ®åº“ | (å¯é€‰) Chroma | è¯­ä¹‰æœç´¢ |
| ä¼šè¯å­˜å‚¨ | Redis (å¯é€‰) | ä¼šè¯ç®¡ç† |

### å®æ–½è®¡åˆ’

**Phase 1: åŸºç¡€ API** (P0)
- [x] FastAPI é¡¹ç›®ç»“æ„
- [ ] Skill åŠ è½½æœåŠ¡
- [ ] åŸºæœ¬é—®ç­”æ¥å£
- [ ] Claude LLM é›†æˆ

**Phase 2: å¢å¼ºåŠŸèƒ½** (P1)
- [ ] GLM-4 æ”¯æŒ
- [ ] ä¼šè¯ç®¡ç†
- [ ] ä¸Šä¸‹æ–‡æ£€ç´¢ä¼˜åŒ–
- [ ] API è®¤è¯

**Phase 3: é«˜çº§ç‰¹æ€§** (P2)
- [ ] å‘é‡åŒ–è¯­ä¹‰æœç´¢
- [ ] å¤šè½®å¯¹è¯æ”¯æŒ
- [ ] é—®ç­”è´¨é‡è¯„ä¼°
- [ ] ç›‘æ§å’Œæ—¥å¿—

### API æ–‡æ¡£ç¤ºä¾‹

å¯åŠ¨æœåŠ¡åè®¿é—®ï¼š
- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

### ç¯å¢ƒå˜é‡

```bash
# .env
ANTHROPIC_API_KEY=sk-xxx        # Claude API
ZHIPU_API_KEY=xxx               # GLM-4 API (å¯é€‰)
REDIS_URL=redis://localhost     # ä¼šè¯å­˜å‚¨ (å¯é€‰)
SKILLS_DIR=../skills_output     # Skill æ–‡ä»¶ç›®å½•
```

### å¼€å‘å‘½ä»¤

```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆè§„åˆ’ä¸­ï¼‰
uvicorn app.main:app --reload --port 8000

# è¿è¡Œæµ‹è¯•ï¼ˆè§„åˆ’ä¸­ï¼‰
pytest tests/test_api/ -v
```

### é¢„æœŸæ€§èƒ½

| æŒ‡æ ‡ | ç›®æ ‡ |
|------|------|
| API å“åº”æ—¶é—´ | < 3ç§’ï¼ˆåŒ…æ‹¬ LLM è°ƒç”¨ï¼‰|
| Skill åŠ è½½æ—¶é—´ | < 1ç§’ï¼ˆå†·å¯åŠ¨ï¼‰|
| å¹¶å‘æ”¯æŒ | 100+ è¯·æ±‚/ç§’ |
| ä¸Šä¸‹æ–‡é•¿åº¦ | æœ€å¤š 50K tokens |

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

### Part 1 æ–‡æ¡£
- **[Pipeline æ¶æ„è¯¦è§£](docs/PIPELINE_ARCHITECTURE.md)** - æ·±å…¥äº†è§£ Pipeline è®¾è®¡
- **[SKILL.md å¢å¼ºè¯´æ˜](docs/SKILL_ENHANCEMENT.md)** - SKILL.md å¢å¼ºåŠŸèƒ½è®¾è®¡
- **[ç¼“å­˜æ ¼å¼æ–‡æ¡£](cache/README.md)** - ç¼“å­˜æ–‡ä»¶æ ¼å¼å’Œç®¡ç†

### Part 2 æ–‡æ¡£
- **API æœåŠ¡æ–‡æ¡£** (è§„åˆ’ä¸­) - FastAPI æ¥å£è¯´æ˜
- **LLM é›†æˆæŒ‡å—** (è§„åˆ’ä¸­) - Claude/GLM-4 é›†æˆ
- **éƒ¨ç½²æŒ‡å—** (è§„åˆ’ä¸­) - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

## ğŸ¤ è´¡çŒ®æŒ‡å—

### å¼€å‘ç¯å¢ƒ

```bash
# å®‰è£…å¼€å‘ä¾èµ–
uv sync --extra dev

# è¿è¡Œæµ‹è¯•
pytest tests/ -v

# ä»£ç æ ¼å¼åŒ–
black .
ruff check .
```

### æ·»åŠ æ–°çš„ LLM Provider

å‚è€ƒ `app/document_processor/llm_cli_providers.py` ä¸­çš„ `LLMCLIProvider` åŸºç±»ã€‚

---

**License**: MIT
**ä½œè€…**: BeanFlow Team
**ç‰ˆæœ¬**: 2.0 (Multi-Stage Pipeline)

# Configuration Management

## Overview
This skill defines the three-tier configuration architecture for BlockMe, focusing on LLM provider configurations, document processing settings, and tax jurisdiction management. The system separates configuration into distinct layers to ensure security, maintainability, and flexibility.

## Three-Tier Configuration Architecture

### Tier 1: Environment Configuration
**Purpose**: External dependencies, API keys, deployment-specific settings
**Location**: `.env` files, environment variables, secrets management
**Access**: Runtime configuration loaded from environment

```python
# config/environment.py
from pydantic_settings import BaseSettings
from typing import Literal

class EnvironmentConfig(BaseSettings):
    """Environment-specific configuration loaded from .env files."""

    # Application Settings
    app_name: str = "BlockMe"
    app_version: str = "1.0.0"
    debug: bool = False
    environment: Literal["development", "staging", "production"] = "development"

    # Database Configuration
    database_url: str
    redis_url: str = "redis://localhost:6379"

    # LLM Provider Configuration
    openai_api_key: str | None = None
    anthropic_api_key: str | None = None
    openai_base_url: str | None = None
    anthropic_base_url: str | None = None

    # Document Storage
    aws_access_key_id: str | None = None
    aws_secret_access_key: str | None = None
    aws_region: str = "us-east-1"
    s3_bucket_name: str | None = None

    # Security
    secret_key: str
    jwt_algorithm: str = "HS256"
    cors_origins: list[str] = ["http://localhost:5173"]

    # Feature Flags
    enable_vision_api: bool = True
    enable_advanced_search: bool = False
    enable_multi_jurisdiction: bool = False

    class Config:
        env_file = ".env"
        case_sensitive = False

# Environment instance
env_config = EnvironmentConfig()
```

### Tier 2: Business Constants
**Purpose**: Domain-specific constants, tax rules, document types, business logic
**Location**: Python modules with `Final` constants
**Access**: Compile-time constants, version-controlled

```python
# config/business_constants.py
from typing import Final
from enum import Enum

# Document Categories and Types
class DocumentCategory(str, Enum):
    TAX_RETURN = "tax_return"
    INVOICE = "invoice"
    RECEIPT = "receipt"
    CONTRACT = "contract"
    FINANCIAL_STATEMENT = "financial_statement"
    TAX_NOTICE = "tax_notice"
    OTHER = "other"

class DocumentType(str, Enum):
    # Tax Returns
    T1_GENERAL = "t1_general"
    T2_CORPORATE = "t2_corporate"
    GST_HST_RETURN = "gst_hst_return"

    # Invoices and Receipts
    SALES_INVOICE = "sales_invoice"
    PURCHASE_INVOICE = "purchase_invoice"
    RECEIPT = "receipt"

    # Legal Documents
    EMPLOYMENT_CONTRACT = "employment_contract"
    SERVICE_AGREEMENT = "service_agreement"
    LEASE_AGREEMENT = "lease_agreement"

# Document Category Mapping
DOCUMENT_CATEGORIES: Final[dict[str, str]] = {
    "tax_return": "Tax Return Documents",
    "invoice": "Invoice Documents",
    "receipt": "Receipt Documents",
    "contract": "Contract Documents",
    "financial_statement": "Financial Statements",
    "tax_notice": "Tax Notices",
    "other": "Other Documents"
}

# Tax Jurisdictions (Canadian Focus)
class TaxJurisdiction(str, Enum):
    FEDERAL = "federal"
    ALBERTA = "ab"
    BRITISH_COLUMBIA = "bc"
    MANITOBA = "mb"
    NEW_BRUNSWICK = "nb"
    NEWFOUNDLAND = "nl"
    NORTHWEST_TERRITORIES = "nt"
    NOVA_SCOTIA = "ns"
    NUNAVUT = "nu"
    ONTARIO = "on"
    PRINCE_EDWARD_ISLAND = "pe"
    QUEBEC = "qc"
    SASKATCHEWAN = "sk"
    YUKON = "yt"

# Tax Rates (2024 rates - update as needed)
GST_RATE: Final[float] = 0.05
HST_RATES: Final[dict[str, float]] = {
    TaxJurisdiction.ON: 0.13,      # Ontario
    TaxJurisdiction.NB: 0.15,      # New Brunswick
    TaxJurisdiction.NS: 0.15,      # Nova Scotia
    TaxJurisdiction.NL: 0.15,      # Newfoundland
    TaxJurisdiction.PE: 0.15,      # Prince Edward Island
}

PST_RATES: Final[dict[str, float]] = {
    TaxJurisdiction.BC: 0.07,      # British Columbia
    TaxJurisdiction.SK: 0.06,      # Saskatchewan
    TaxJurisdiction.MB: 0.07,      # Manitoba
    TaxJurisdiction.QC: 0.09975,   # Quebec (QST)
}

# LLM Provider Configuration
class LLMProvider(str, Enum):
    OPENAI = "openai"
    ANTHROPIC = "anthropic"
    GLM = "glm"

# LLM Models by Provider
LLM_MODELS: Final[dict[str, dict[str, str]]] = {
    LLMProvider.OPENAI: {
        "chat": "gpt-4o-mini",
        "vision": "gpt-4o",
        "embedding": "text-embedding-3-small",
        "cheap": "gpt-3.5-turbo"
    },
    LLMProvider.ANTHROPIC: {
        "chat": "claude-3-5-haiku-20241022",
        "vision": "claude-3-5-sonnet-20241022",
        "embedding": None,  # Not available
        "cheap": "claude-3-5-haiku-20241022"
    },
    LLMProvider.GLM: {
        "chat": "glm-4.6",
        "vision": "glm-4.6v",
        "embedding": "embedding-2",
        "cheap": "glm-4-flash"
    }
}

# Document Processing Limits
MAX_FILE_SIZE: Final[int] = 50 * 1024 * 1024  # 50MB
SUPPORTED_FORMATS: Final[set[str]] = {
    ".pdf", ".docx", ".xlsx", ".pptx",
    ".jpg", ".jpeg", ".png", ".tiff"
}

# Tax Domain Constants
TAX_YEARS: Final[dict[str, range]] = {
    "current": range(2023, 2025),
    "historical": range(2015, 2023),
    "future": range(2025, 2027)
}

# Standard Tax Deductions (Canada)
STANDARD_DEDUCTIONS: Final[dict[str, float]] = {
    "basic_personal_amount": 15000.00,  # 2024 amount
    "cpp_basic_exemption": 3500.00,
    "ei_insurable_earnings_max": 63200.00,
}

# Business Expense Categories
BUSINESS_EXPENSE_CATEGORIES: Final[dict[str, list[str]]] = {
    "office": ["rent", "utilities", "supplies", "maintenance"],
    "vehicle": ["fuel", "insurance", "maintenance", "lease"],
    "professional": ["legal", "accounting", "consulting"],
    "marketing": ["advertising", "promotion", "website"],
    "travel": ["accommodation", "meals", "transportation"],
    "other": ["bank_fees", "insurance", "licenses"]
}
```

### Tier 3: Application Configuration
**Purpose**: Runtime behavior, caching, retry policies, formatting rules
**Location**: Configuration classes loaded at startup
**Access**: Runtime configurable, potentially dynamic

```python
# config/application.py
from dataclasses import dataclass
from typing import Any, Dict, Optional
import asyncio

@dataclass
class CacheConfig:
    """Caching configuration."""
    # Redis Cache TTL (seconds)
    document_cache_ttl: int = 3600        # 1 hour
    llm_response_cache_ttl: int = 1800    # 30 minutes
    tax_calculation_cache_ttl: int = 7200 # 2 hours

    # Cache Key Prefixes
    document_prefix: str = "doc:"
    llm_prefix: str = "llm:"
    tax_prefix: str = "tax:"

    # Cache Sizes
    max_memory_cache: int = 1000         # Max items in memory cache

@dataclass
class RetryConfig:
    """Retry configuration for external services."""
    # LLM API Retry
    llm_max_retries: int = 3
    llm_retry_delay: float = 1.0         # Initial delay in seconds
    llm_retry_backoff: float = 2.0       # Backoff multiplier
    llm_retry_jitter: bool = True        # Add jitter to retry delays

    # Database Retry
    db_max_retries: int = 2
    db_retry_delay: float = 0.5

    # File Storage Retry
    storage_max_retries: int = 3
    storage_retry_delay: float = 2.0

@dataclass
class LLMConfig:
    """LLM-specific configuration."""
    # Rate Limiting
    requests_per_minute: int = 60
    requests_per_hour: int = 1000

    # Token Limits
    max_tokens_per_request: int = 4000
    max_response_tokens: int = 1000

    # Cost Management
    daily_cost_limit: float = 50.0       # USD
    cost_tracking_enabled: bool = True

    # Default Providers
    default_chat_provider: str = "openai"
    default_vision_provider: str = "anthropic"
    fallback_provider: str = "openai"

    # Prompt Configuration
    system_prompt_temperature: float = 0.1
    user_query_temperature: float = 0.7
    document_analysis_temperature: float = 0.3

@dataclass
class DocumentProcessingConfig:
    """Document processing configuration."""
    # Vision API Settings
    vision_max_image_size: int = 20 * 1024 * 1024  # 20MB
    vision_supported_formats: set[str] = frozenset([
        ".jpg", ".jpeg", ".png", ".tiff", ".pdf"
    ])

    # OCR Settings
    ocr_enabled: bool = True
    ocr_languages: list[str] = ["eng", "fra"]  # English, French for Canada

    # Processing Timeout
    document_processing_timeout: int = 300     # 5 minutes
    batch_processing_size: int = 10

    # Quality Thresholds
    min_confidence_threshold: float = 0.7
    min_text_density: float = 0.1

@dataclass
class TaxConfig:
    """Tax calculation and jurisdiction configuration."""
    # Default Jurisdiction
    default_province: str = "on"  # Ontario
    default_country: str = "ca"   # Canada

    # Calculation Settings
    include_pst: bool = True
    include_gst: bool = True
    include_hst: bool = True

    # Validation Settings
    validate_tax_rules: bool = True
    cross_jurisdiction_validation: bool = False

class AppConfig:
    """Main application configuration."""

    def __init__(self):
        self.cache = CacheConfig()
        self.retry = RetryConfig()
        self.llm = LLMConfig()
        self.document_processing = DocumentProcessingConfig()
        self.tax = TaxConfig()

        # Load any dynamic configuration
        self._load_dynamic_config()

    def _load_dynamic_config(self):
        """Load configuration from database or external sources."""
        # This could load user preferences, feature flags, etc.
        pass

    def get_llm_config(self, provider: str) -> Dict[str, Any]:
        """Get LLM configuration for specific provider."""
        return {
            "api_key": getattr(env_config, f"{provider}_api_key"),
            "base_url": getattr(env_config, f"{provider}_base_url", None),
            "model": LLM_MODELS.get(provider, {}),
            "rate_limit": {
                "requests_per_minute": self.llm.requests_per_minute,
                "requests_per_hour": self.llm.requests_per_hour,
            },
            "cost_limit": self.llm.daily_cost_limit
        }

    def is_jurisdiction_enabled(self, jurisdiction: str) -> bool:
        """Check if a tax jurisdiction is enabled."""
        if jurisdiction == "federal":
            return True
        return env_config.enable_multi_jurisdiction or jurisdiction == self.tax.default_province

# Global application configuration instance
app_config = AppConfig()
```

## Environment Files

### Development Environment (.env.development)
```bash
# Development Configuration
DEBUG=true
ENVIRONMENT=development

# Database (Development)
DATABASE_URL=postgresql://blockme:password@localhost:5432/blockme_dev
REDIS_URL=redis://localhost:6379/0

# LLM Provider Keys (Development)
OPENAI_API_KEY=your_openai_api_key_here
ANTHROPIC_API_KEY=your_anthropic_api_key_here

# Storage (Development - Local)
AWS_ACCESS_KEY_ID=dev_key
AWS_SECRET_ACCESS_KEY=dev_secret
AWS_REGION=us-east-1
S3_BUCKET_NAME=blockme-dev-documents

# Security (Development)
SECRET_KEY=dev-secret-key-change-in-production

# Feature Flags (Development)
ENABLE_VISION_API=true
ENABLE_ADVANCED_SEARCH=true
ENABLE_MULTI_JURISDICTION=true
```

### Production Environment (.env.production)
```bash
# Production Configuration
DEBUG=false
ENVIRONMENT=production

# Database (Production)
DATABASE_URL=postgresql://user:password@prod-db:5432/blockme_prod
REDIS_URL=redis://prod-redis:6379/0

# LLM Provider Keys (Production)
OPENAI_API_KEY=prod_openai_api_key
ANTHROPIC_API_KEY=prod_anthropic_api_key

# Storage (Production - AWS)
AWS_ACCESS_KEY_ID=prod_aws_access_key
AWS_SECRET_ACCESS_KEY=prod_aws_secret_key
AWS_REGION=ca-central-1
S3_BUCKET_NAME=blockme-prod-documents

# Security (Production)
SECRET_KEY=super-secure-production-secret-key
CORS_ORIGINS=["https://app.blockme.tax", "https://blockme.tax"]

# Feature Flags (Production)
ENABLE_VISION_API=true
ENABLE_ADVANCED_SEARCH=false
ENABLE_MULTI_JURISDICTION=false
```

## Configuration Loading

### Main Configuration Loader
```python
# config/__init__.py
from .environment import env_config
from .application import app_config
from .business_constants import *

__all__ = [
    "env_config",
    "app_config",
    # Business constants
    "DocumentCategory",
    "DocumentType",
    "TaxJurisdiction",
    "LLMProvider",
    "DOCUMENT_CATEGORIES",
    "LLM_MODELS",
    "GST_RATE",
    "HST_RATES",
    "PST_RATES",
    "MAX_FILE_SIZE",
    "SUPPORTED_FORMATS",
]

def get_config_summary():
    """Get a summary of current configuration (without secrets)."""
    return {
        "environment": env_config.environment,
        "debug": env_config.debug,
        "features": {
            "vision_api": env_config.enable_vision_api,
            "advanced_search": env_config.enable_advanced_search,
            "multi_jurisdiction": env_config.enable_multi_jurisdiction,
        },
        "llm_providers": list(LLM_MODELS.keys()),
        "supported_formats": list(SUPPORTED_FORMATS),
        "tax_jurisdictions": list(TaxJurisdiction),
    }
```

## Configuration Validation

### Startup Validation
```python
# config/validation.py
from typing import List
import logging

logger = logging.getLogger(__name__)

def validate_configuration() -> List[str]:
    """Validate configuration at startup. Returns list of warnings/errors."""
    warnings = []
    errors = []

    # Validate required environment variables
    if not env_config.database_url:
        errors.append("DATABASE_URL is required")

    if not env_config.secret_key:
        errors.append("SECRET_KEY is required")

    # Validate LLM provider configuration
    llm_providers_configured = []
    if env_config.openai_api_key:
        llm_providers_configured.append("openai")
    if env_config.anthropic_api_key:
        llm_providers_configured.append("anthropic")

    if not llm_providers_configured:
        errors.append("At least one LLM provider API key must be configured")

    # Validate storage configuration
    if not env_config.s3_bucket_name:
        warnings.append("No S3 bucket configured - using local storage")

    # Validate feature flag consistency
    if env_config.enable_multi_jurisdiction and len(PST_RATES) == 0:
        warnings.append("Multi-jurisdiction enabled but PST rates not configured")

    # Log validation results
    if errors:
        logger.error(f"Configuration errors: {errors}")
        raise ValueError(f"Configuration validation failed: {errors}")

    if warnings:
        logger.warning(f"Configuration warnings: {warnings}")

    logger.info(f"Configuration validated successfully. Environment: {env_config.environment}")
    return warnings

# Call validation at startup
def initialize_configuration():
    """Initialize and validate configuration."""
    validate_configuration()
    logger.info("Configuration initialized successfully")
```

## Configuration Management Best Practices

### 1. Security
- **Never commit API keys** or sensitive data to version control
- **Use environment variables** for all secrets
- **Rotate keys regularly** and update environment files
- **Use different keys** for development and production

### 2. Environment Management
- **Separate environments** for development, staging, and production
- **Document all configuration options** and their purposes
- **Use default values** where appropriate
- **Validate configuration** at startup

### 3. Change Management
- **Track configuration changes** in version control (excluding secrets)
- **Document changes** in configuration files
- **Test configuration changes** in development first
- **Use feature flags** for gradual rollouts

### 4. Monitoring
- **Log configuration loading** at startup
- **Monitor configuration-related errors**
- **Track LLM usage and costs**
- **Validate external service connectivity**

## Related Skills
- **[development-policies](development-policies)** - General development standards
- **[llm-usage-guide](llm-usage-guide)** - LLM provider usage patterns
- **[backend-development](backend-development)** - Backend development standards
- **[core-architecture](core-architecture)** - System architecture principles

## Usage Hints
Trigger this skill when:
- Setting up new development environments
- Configuring LLM providers
- Adding new tax jurisdictions
- Modifying document processing settings
- Managing environment-specific configurations
- Troubleshooting configuration-related issues
- Planning configuration changes for deployment
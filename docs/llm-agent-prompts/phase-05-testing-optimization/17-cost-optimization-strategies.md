# ä»»åŠ¡17ï¼šSkill-like æ–¹æ¡ˆæˆæœ¬ä¼˜åŒ–ç­–ç•¥

## ä»»åŠ¡ç›®æ ‡

å®ç° Skill-like æ–¹æ¡ˆçš„æˆæœ¬ä¼˜åŒ–ç­–ç•¥ï¼Œä¸»è¦é™ä½ Claude è·¯ç”± API çš„ä½¿ç”¨æˆæœ¬ã€‚é€šè¿‡è·¯ç”±ç»“æœç¼“å­˜ã€é¢„çƒ­å¸¸è§é—®é¢˜ã€è¯­ä¹‰ç›¸ä¼¼é—®é¢˜å»é‡ã€æ··åˆè·¯ç”±ç­–ç•¥ç­‰æŠ€æœ¯æ‰‹æ®µï¼Œåœ¨ä¿è¯æœåŠ¡è´¨é‡çš„å‰æä¸‹æœ€å¤§ç¨‹åº¦èŠ‚çœ API è´¹ç”¨ã€‚

**ä¸ RAG æ–¹æ¡ˆçš„æˆæœ¬å·®å¼‚ï¼š**
- âœ… æ¶ˆé™¤ï¼šEmbedding æ¨¡å‹æˆæœ¬ï¼ˆ$0ï¼‰
- âœ… æ¶ˆé™¤ï¼šå‘é‡æ•°æ®åº“æˆæœ¬ï¼ˆ$0ï¼‰
- âœ… æ¶ˆé™¤ï¼šBM25/FTS5 æ£€ç´¢æˆæœ¬ï¼ˆ$0ï¼‰
- âŒ æ–°å¢ï¼šè·¯ç”±æˆæœ¬ï¼ˆ~$0.00113/æ¬¡ï¼Œå¯é€šè¿‡ç¼“å­˜ä¼˜åŒ–ï¼‰
- âœ… é™ä½ï¼šé—®ç­”æˆæœ¬ï¼ˆä½¿ç”¨ GLM-4.6 ä»£æ›¿ Claude Sonnetï¼‰

## ğŸ¯ æ¨èçš„æ··åˆæ¨¡å‹æ¶æ„

åŸºäºæˆæœ¬å’Œè´¨é‡çš„å¹³è¡¡è€ƒè™‘ï¼Œæœ¬æ–¹æ¡ˆé‡‡ç”¨ä»¥ä¸‹æ··åˆæ¨¡å‹æ¶æ„ï¼š

```
ç”¨æˆ·é—®é¢˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Skill è·¯ç”±å±‚                              â”‚
â”‚ â†’ Claude Haiku 4.5                       â”‚
â”‚   æˆæœ¬ï¼š$0.00113/æ¬¡                       â”‚
â”‚   ä¼˜åŠ¿ï¼šå‡†ç¡®ç‡é«˜ã€é€Ÿåº¦å¿«ã€æˆæœ¬ä½            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Skill åŠ è½½                                â”‚
â”‚ â†’ å®Œæ•´ Markdown Skillsï¼ˆæ— éœ€å‘é‡åŒ–ï¼‰      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ€ç»ˆé—®ç­”å±‚                                â”‚
â”‚ â†’ GLM-4.6ï¼ˆä¸­è‹±æ–‡ç»Ÿä¸€ï¼‰                   â”‚
â”‚   æˆæœ¬ï¼š$0.0085/æ¬¡                        â”‚
â”‚   ä¼˜åŠ¿ï¼šä¸­è‹±æ–‡èƒ½åŠ›å¼ºã€æ¨ç†ä¼˜ç§€ã€æ¶æ„ç®€å•     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¾…åŠ©ä»»åŠ¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–‡æ¡£ OCR å¤„ç†                             â”‚
â”‚ â†’ Gemini 2.5 Flash                       â”‚
â”‚   æˆæœ¬ï¼š$0.0012/æ¬¡                        â”‚
â”‚   ä¼˜åŠ¿ï¼šVision èƒ½åŠ›å¼ºã€OCR å‡†ç¡®            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ–¹æ¡ˆé€‰æ‹©ç†ç”±

**1. Claude Haiku 4.5 ç”¨äº Skill è·¯ç”±**
- âœ… è·¯ç”±å‡†ç¡®ç‡ > 90%ï¼ˆæ¥è¿‘ Sonnetï¼‰
- âœ… é€Ÿåº¦å¿«ï¼ˆ1-2ç§’ï¼‰
- âœ… æˆæœ¬æ˜¯ Sonnet çš„ 1/3
- âœ… æ”¯æŒç»“æ„åŒ– JSON è¾“å‡º

**2. GLM-4.6 ç”¨äºæœ€ç»ˆé—®ç­”**
- âœ… è‹±æ–‡æŠ€æœ¯èƒ½åŠ›å¼ºï¼ˆMMLU 81.2%ï¼Œä¼˜äº Gemini Flash 78.9%ï¼‰
- âœ… ä¸­æ–‡èƒ½åŠ›é¡¶çº§ï¼ˆå›½å†…æ¨¡å‹ä¼˜åŠ¿ï¼‰
- âœ… æ¨ç†èƒ½åŠ›å¼ºï¼ˆGSM8K 89.5%ï¼Œä¼˜äº Gemini Flash 85.7%ï¼‰
- âœ… æ¶æ„ç®€å•ï¼ˆæ— éœ€è¯­è¨€æ£€æµ‹å’Œæ¨¡å‹åˆ‡æ¢ï¼‰
- âœ… æˆæœ¬é€‚ä¸­ï¼ˆ$0.50/M tokens vs Claude $3.0/Mï¼‰

**3. Gemini 2.5 Flash ç”¨äºæ–‡æ¡£ OCR**
- âœ… Vision èƒ½åŠ›å¼º
- âœ… OCR å‡†ç¡®ç‡é«˜
- âœ… æˆæœ¬æä½ï¼ˆ$0.075/M tokensï¼‰

### æˆæœ¬å¯¹æ¯”åˆ†æ

#### å•æ¬¡é—®ç­”æˆæœ¬

| æ–¹æ¡ˆ | è·¯ç”±æ¨¡å‹ | è·¯ç”±æˆæœ¬ | é—®ç­”æ¨¡å‹ | é—®ç­”æˆæœ¬ | æ€»æˆæœ¬ | vs åŸæ–¹æ¡ˆ |
|------|---------|---------|---------|---------|--------|-----------|
| **åŸæ–¹æ¡ˆ** | Sonnet | $0.003 | Sonnet | $0.075 | **$0.078** | - |
| **æ¨èæ–¹æ¡ˆ** | **Haiku 4.5** | **$0.00113** | **GLM-4.6** | **$0.0085** | **$0.00963** | **â†“ 88%** |
| å¤‡é€‰æ–¹æ¡ˆ1 | Haiku 4.5 | $0.00113 | Haiku 4.5 | $0.0048 | $0.00593 | â†“ 92% |
| å¤‡é€‰æ–¹æ¡ˆ2 | Haiku 4.5 | $0.00113 | Gemini Flash | $0.0018 | $0.00293 | â†“ 96% |

**æˆæœ¬è®¡ç®—è¯´æ˜ï¼š**
- Claude Haiku 4.5ï¼š$1.0/M input, $5.0/M output
- GLM-4.6ï¼š~$0.50/M tokensï¼ˆinput/output ç›¸è¿‘ï¼‰
- Gemini 2.5 Flashï¼š$0.075/M input, $0.30/M output
- å‡è®¾è·¯ç”±ï¼š1K input + 0.2K output
- å‡è®¾é—®ç­”ï¼š15K input + 2K output

#### æœˆåº¦æˆæœ¬ä¼°ç®—ï¼ˆ1ä¸‡æ¬¡æŸ¥è¯¢/å¤©ï¼‰

| æ–¹æ¡ˆ | æ—¥æˆæœ¬ | æœˆæˆæœ¬ | å¹´æˆæœ¬ | vs åŸæ–¹æ¡ˆèŠ‚çœ |
|------|--------|--------|--------|---------------|
| åŸæ–¹æ¡ˆï¼ˆå…¨ Sonnetï¼‰ | $780 | $23,400 | $280,800 | - |
| **æ¨èæ–¹æ¡ˆï¼ˆHaiku + GLMï¼‰** | **$96.3** | **$2,889** | **$34,668** | **$246,132/å¹´** |

**æŠ•èµ„å›æŠ¥ç‡ï¼ˆROIï¼‰ï¼š**
- å¹´åº¦èŠ‚çœï¼š$246,132
- èŠ‚çœæ¯”ä¾‹ï¼š88%
- å¦‚æœç”¨æˆ·è§„æ¨¡æ‰©å¤§ 10 å€ï¼Œå¹´åº¦èŠ‚çœ > $240 ä¸‡

## æŠ€æœ¯è¦æ±‚

**ä¼˜åŒ–ç»´åº¦ï¼š**
- **Skill è·¯ç”±ä¼˜åŒ–**ï¼ˆæœ€å…³é”®ï¼‰- ç¼“å­˜ã€é¢„çƒ­ã€è¯­ä¹‰å»é‡
- Claude/GLM Vision API ä¼˜åŒ–ï¼ˆæ–‡æ¡£å¤„ç†ï¼‰
- å¯¹è¯ç¼“å­˜ç­–ç•¥
- æ‰¹é‡å¤„ç†ä¼˜åŒ–

**æˆæœ¬ç›‘æ§ï¼š**
- è·¯ç”±æˆæœ¬è¿½è¸ª
- ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§
- é¢„ç®—è­¦æŠ¥
- æˆæœ¬åˆ†ææŠ¥å‘Š

**ä¼˜åŒ–ç›®æ ‡ï¼š**
- è·¯ç”±ç¼“å­˜å‘½ä¸­ç‡ > 50%
- è·¯ç”±æˆæœ¬é™ä½ 50-70%
- ä¸å½±å“ç”¨æˆ·ä½“éªŒ

## å®ç°æ­¥éª¤

### 1. å®ç°è·¯ç”±ç»“æœç¼“å­˜ï¼ˆæœ€å…³é”®ï¼‰

ä½¿ç”¨ Redis æŒä¹…åŒ–ç¼“å­˜è·¯ç”±ç»“æœï¼š
- è®¡ç®—æŸ¥è¯¢çš„ç¼“å­˜é”®ï¼ˆå“ˆå¸Œï¼‰
- ç¼“å­˜æœ‰æ•ˆæœŸ 24 å°æ—¶
- ç¼“å­˜å‘½ä¸­åç›´æ¥è¿”å›è·¯ç”±ç»“æœï¼ˆè·³è¿‡ Claude APIï¼‰

### 2. å®ç°å¸¸è§é—®é¢˜é¢„çƒ­

ç³»ç»Ÿå¯åŠ¨æ—¶é¢„çƒ­é«˜é¢‘é—®é¢˜ï¼š
- æå‰è·¯ç”±å¸¸è§é—®é¢˜
- ç¼“å­˜ç»“æœä¾›åç»­ä½¿ç”¨
- èŠ‚çœé«˜é¢‘æŸ¥è¯¢çš„è·¯ç”±æˆæœ¬

### 3. å®ç°è¯­ä¹‰ç›¸ä¼¼é—®é¢˜å»é‡

ä½¿ç”¨å°å‹ embedding æ¨¡å‹æ£€æµ‹ç›¸ä¼¼é—®é¢˜ï¼š
- æœ¬åœ°è¿è¡Œ `all-MiniLM-L6-v2`ï¼ˆå…è´¹ï¼‰
- è®¡ç®—æŸ¥è¯¢ç›¸ä¼¼åº¦
- ç›¸ä¼¼åº¦ > 0.85 æ—¶å¤ç”¨ç¼“å­˜è·¯ç”±ç»“æœ

### 4. å®ç°æ··åˆè·¯ç”±ç­–ç•¥

ç»“åˆè§„åˆ™åŒ¹é…å’Œ Claude è·¯ç”±ï¼š
- ç¬¬ä¸€æ­¥ï¼šå°è¯•è§„åˆ™åŒ¹é…ï¼ˆå…è´¹ï¼ŒåŸºäº triggersï¼‰
- ç¬¬äºŒæ­¥ï¼šClaude è·¯ç”±ï¼ˆä»˜è´¹ï¼Œå‡†ç¡®æ€§é«˜ï¼‰
- è§„åˆ™å‘½ä¸­ç‡ 20-30%ï¼ŒèŠ‚çœè·¯ç”±æˆæœ¬

### 5. å®ç°æˆæœ¬ç›‘æ§

è¿½è¸ªè·¯ç”±å’Œé—®ç­”æˆæœ¬ï¼š
- è·¯ç”±è°ƒç”¨ç»Ÿè®¡
- ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡
- è´¹ç”¨è®¡ç®—
- é¢„ç®—ç®¡ç†
- å‘Šè­¦é€šçŸ¥

## å…³é”®ä»£ç æç¤º

### 1. è·¯ç”±æˆæœ¬ä¼˜åŒ–

#### 1.1 è·¯ç”±ç»“æœç¼“å­˜

```python
class CachedSkillRouter(ClaudeSkillRouter):
    """å¸¦æŒä¹…åŒ–ç¼“å­˜çš„è·¯ç”±å™¨"""

    def __init__(self, *args, cache_backend="redis", **kwargs):
        super().__init__(*args, **kwargs)
        self.cache_backend = cache_backend

        if cache_backend == "redis":
            import redis
            self.cache = redis.Redis(host='localhost', port=6379, db=0)
        else:
            self.cache = {}  # å†…å­˜ç¼“å­˜

    def route(self, user_query: str, use_cache: bool = True) -> Dict:
        if not use_cache:
            return super().route(user_query, use_cache=False)

        cache_key = self._compute_cache_key(user_query)

        # å°è¯•ä» Redis è·å–
        if self.cache_backend == "redis":
            cached = self.cache.get(cache_key)
            if cached:
                import json
                result = json.loads(cached)
                result["from_cache"] = True
                return result

        # ç¼“å­˜æœªå‘½ä¸­ï¼Œè°ƒç”¨ Claude
        result = super().route(user_query, use_cache=False)

        # ä¿å­˜åˆ° Redisï¼ˆæœ‰æ•ˆæœŸ 24 å°æ—¶ï¼‰
        if self.cache_backend == "redis":
            import json
            self.cache.setex(
                cache_key,
                86400,  # 24 hours
                json.dumps(result)
            )

        return result
```

**é¢„æœŸæ•ˆæœï¼š**
- ç¼“å­˜å‘½ä¸­ç‡ 50-70%
- æˆæœ¬èŠ‚çœ 50-70%
- å“åº”æ—¶é—´ä» 2s é™è‡³ < 10ms

#### 1.2 é¢„çƒ­å¸¸è§é—®é¢˜

```python
def preheat_cache(router: CachedSkillRouter, common_questions: List[str]):
    """é¢„çƒ­ç¼“å­˜"""
    print(f"é¢„çƒ­ {len(common_questions)} ä¸ªå¸¸è§é—®é¢˜...")

    for question in common_questions:
        router.route(question, use_cache=False)

    print("é¢„çƒ­å®Œæˆï¼")

# ä½¿ç”¨ç¤ºä¾‹
common_questions = [
    "è¨çœç¨ç‡æ˜¯å¤šå°‘ï¼Ÿ",
    "RRSP å’Œ TFSA çš„åŒºåˆ«ï¼Ÿ",
    "å¦‚ä½•ç”³æŠ¥ç§Ÿé‡‘æ”¶å…¥ï¼Ÿ",
    # ... æ›´å¤šå¸¸è§é—®é¢˜
]

preheat_cache(router, common_questions)
```

#### 1.3 è¯­ä¹‰ç›¸ä¼¼é—®é¢˜å»é‡

```python
from sentence_transformers import SentenceTransformer, util

class SemanticCachedRouter(CachedSkillRouter):
    """è¯­ä¹‰ç¼“å­˜è·¯ç”±å™¨"""

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # ä½¿ç”¨å°å‹ embedding æ¨¡å‹åšç›¸ä¼¼åº¦åŒ¹é…
        self.embedder = SentenceTransformer('all-MiniLM-L6-v2')
        self.question_embeddings = {}

    def route(self, user_query: str, similarity_threshold: float = 0.85) -> Dict:
        # è®¡ç®—æŸ¥è¯¢çš„ embedding
        query_emb = self.embedder.encode(user_query)

        # æŸ¥æ‰¾ç›¸ä¼¼çš„å·²ç¼“å­˜é—®é¢˜
        for cached_q, cached_emb in self.question_embeddings.items():
            similarity = util.cos_sim(query_emb, cached_emb).item()

            if similarity > similarity_threshold:
                print(f"æ‰¾åˆ°ç›¸ä¼¼é—®é¢˜: {cached_q} (ç›¸ä¼¼åº¦: {similarity:.2f})")
                # ä½¿ç”¨ç¼“å­˜çš„è·¯ç”±ç»“æœ
                cache_key = self._compute_cache_key(cached_q)
                return self.get_from_cache(cache_key)

        # æœªæ‰¾åˆ°ç›¸ä¼¼é—®é¢˜ï¼Œæ­£å¸¸è·¯ç”±
        result = super().route(user_query)

        # ä¿å­˜ embedding
        self.question_embeddings[user_query] = query_emb

        return result
```

**æˆæœ¬å¯¹æ¯”ï¼š**
- å°å‹ embeddingï¼ˆæœ¬åœ°ï¼‰ï¼šå…è´¹
- Claude Haiku è·¯ç”±ï¼š$0.0009/æ¬¡
- è¯­ä¹‰ç¼“å­˜å‘½ä¸­åï¼š$0ï¼ˆå®Œå…¨å…è´¹ï¼‰

### 2. æ··åˆæ¨¡å‹æ–¹æ¡ˆçš„æˆæœ¬ä¼˜åŠ¿

#### 2.1 æ¨èæ–¹æ¡ˆï¼ˆHaiku + GLMï¼‰è¯¦ç»†æˆæœ¬

**å•æ¬¡é—®ç­”æˆæœ¬ï¼š**

| ç»„ä»¶ | æ¨¡å‹ | Token æ¶ˆè€— | æˆæœ¬è®¡ç®— | æˆæœ¬ |
|------|------|-----------|---------|------|
| è·¯ç”± | Haiku 4.5 | 1K in + 0.2K out | (1K Ã— $1.0 + 0.2K Ã— $5.0)/1M | $0.00113 |
| Skills åŠ è½½ | - | 12K (2ä¸ª Skills) | $0 | $0 |
| é—®ç­” | GLM-4.6 | 15K in + 2K out | (17K Ã— $0.50)/1M | $0.0085 |
| **æ€»è®¡** | - | **~18K** | - | **$0.00963** |

**vs åŸæ–¹æ¡ˆï¼ˆå…¨ Sonnetï¼‰ï¼š**
- åŸæ–¹æ¡ˆï¼š$0.078/æ¬¡
- æ–°æ–¹æ¡ˆï¼š$0.00963/æ¬¡
- **èŠ‚çœï¼š88%**

#### 2.2 æœˆåº¦æˆæœ¬ä¼°ç®—ï¼ˆä¸åŒè§„æ¨¡ï¼‰

| ç”¨æˆ·è§„æ¨¡ | æŸ¥è¯¢/å¤© | æ— ç¼“å­˜æœˆæˆæœ¬ | 50%ç¼“å­˜æœˆæˆæœ¬ | 70%ç¼“å­˜æœˆæˆæœ¬ | å¹´æˆæœ¬ï¼ˆ70%ç¼“å­˜ï¼‰ |
|---------|--------|-------------|--------------|--------------|-----------------|
| 100 ç”¨æˆ· | 1,000 | $289 | $172 | $130 | $1,560 |
| 1,000 ç”¨æˆ· | 10,000 | $2,889 | $1,734 | $1,300 | $15,600 |
| 10,000 ç”¨æˆ· | 100,000 | $28,890 | $17,340 | $13,000 | $156,000 |

**å¯¹æ¯”åŸæ–¹æ¡ˆï¼ˆå…¨ Sonnetï¼‰ï¼š**

| è§„æ¨¡ | åŸæ–¹æ¡ˆå¹´æˆæœ¬ | æ–°æ–¹æ¡ˆå¹´æˆæœ¬ | å¹´åº¦èŠ‚çœ | èŠ‚çœæ¯”ä¾‹ |
|------|-------------|-------------|---------|----------|
| 100 ç”¨æˆ· | $12,636 | $1,560 | $11,076 | 88% |
| 1,000 ç”¨æˆ· | $126,360 | $15,600 | $110,760 | 88% |
| 10,000 ç”¨æˆ· | $1,263,600 | $156,000 | $1,107,600 | 88% |

#### 2.3 ä¸å…¶ä»–æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | è·¯ç”± | é—®ç­” | å•æ¬¡æˆæœ¬ | æœˆæˆæœ¬(1ä¸‡/å¤©) | ä¼˜ç¼ºç‚¹ |
|------|------|------|---------|---------------|--------|
| **æ¨èï¼šHaiku + GLM** | Haiku 4.5 | GLM-4.6 | **$0.00963** | **$2,889** | âœ… æˆæœ¬ä½ã€è´¨é‡å¥½ã€æ¶æ„ç®€å• |
| å…¨ Haiku | Haiku 4.5 | Haiku 4.5 | $0.00593 | $1,779 | âœ… æˆæœ¬æ›´ä½ âŒ è‹±æ–‡èƒ½åŠ›ç¨å¼± |
| Haiku + Gemini | Haiku 4.5 | Gemini Flash | $0.00293 | $879 | âœ… æˆæœ¬æœ€ä½ âŒ æ¨ç†èƒ½åŠ›å¼± |
| å…¨ Sonnet | Sonnet | Sonnet | $0.078 | $23,400 | âœ… è´¨é‡æœ€é«˜ âŒ æˆæœ¬æé«˜ |

#### 2.4 æ–¹æ¡ˆé€‰æ‹©å»ºè®®

| åœºæ™¯ | æ¨èæ–¹æ¡ˆ | ç†ç”± |
|------|---------|------|
| **æŠ€æœ¯çŸ¥è¯†åº“ï¼ˆè‹±æ–‡ä¸ºä¸»ï¼‰** | **Haiku + GLM** | æ¨ç†èƒ½åŠ›å¼ºï¼Œè‹±æ–‡æŠ€æœ¯å†…å®¹ç†è§£å¥½ |
| ä¸¥æ ¼é¢„ç®—é™åˆ¶ | Haiku + Gemini Flash | æˆæœ¬æœ€ä½ï¼ˆ$879/æœˆï¼‰ |
| è´¨é‡ä¼˜å…ˆ | Haiku + Haiku | æ¥è¿‘ Sonnet è´¨é‡ï¼Œæˆæœ¬é™ä½ 92% |
| ä¸­æ–‡ä¸ºä¸» | Haiku + GLM | GLM ä¸­æ–‡èƒ½åŠ›é¡¶çº§ |

**ä¸ºä»€ä¹ˆæ¨è Haiku + GLMï¼š**
1. âœ… **æˆæœ¬ä¼˜åŠ¿æ˜æ˜¾**ï¼š88% èŠ‚çœï¼Œå¹´çœ $11.1 ä¸‡ï¼ˆ1000 ç”¨æˆ·è§„æ¨¡ï¼‰
2. âœ… **è´¨é‡æœ‰ä¿è¯**ï¼šGLM åœ¨æŠ€æœ¯é¢†åŸŸè¡¨ç°ä¼˜äº Gemini Flash
3. âœ… **æ¶æ„æœ€ç®€å•**ï¼šæ— éœ€è¯­è¨€æ£€æµ‹ï¼Œç»Ÿä¸€ä½¿ç”¨ GLM
4. âœ… **ä¸­è‹±æ–‡å…¼é¡¾**ï¼šGLM è‹±æ–‡èƒ½åŠ›è¶³å¤Ÿï¼Œä¸­æ–‡é¡¶çº§

### 3. æè‡´æˆæœ¬ä¼˜åŒ–ï¼šæ··åˆè·¯ç”±ç­–ç•¥

```python
class HybridRouter:
    """æ··åˆè·¯ç”±å™¨ï¼šè§„åˆ™ + Claude"""

    def __init__(self, skill_loader, claude_router):
        self.skill_loader = skill_loader
        self.claude_router = claude_router
        self.rule_based_hits = 0
        self.claude_hits = 0

    def route(self, user_query: str) -> Dict:
        # ç¬¬ä¸€æ­¥ï¼šå°è¯•è§„åˆ™åŒ¹é…ï¼ˆå…è´¹ï¼‰
        rule_result = self._rule_based_route(user_query)

        if rule_result and rule_result.get("confidence") == "high":
            self.rule_based_hits += 1
            print(f"âœ… è§„åˆ™è·¯ç”±å‘½ä¸­ (èŠ‚çœ $0.001)")
            return rule_result

        # ç¬¬äºŒæ­¥ï¼šä½¿ç”¨ Claude è·¯ç”±
        self.claude_hits += 1
        return self.claude_router.route(user_query)

    def _rule_based_route(self, query: str) -> Optional[Dict]:
        """åŸºäºè§„åˆ™çš„å¿«é€Ÿè·¯ç”±"""
        query_lower = query.lower()

        # å¼ºè§„åˆ™åŒ¹é…
        for skill_id, skill_info in self.skill_loader.index.items():
            triggers = skill_info["metadata"].get("triggers", [])

            # å®Œå…¨åŒ¹é…è§¦å‘è¯
            for trigger in triggers:
                if trigger.lower() in query_lower:
                    return {
                        "primary_skills": [{
                            "skill_id": skill_id,
                            "title": skill_info["metadata"]["title"],
                            "path": skill_info["path"],
                            "tokens": skill_info["metadata"].get("estimated_tokens", 5000)
                        }],
                        "related_skills": [],
                        "reasoning": f"è§„åˆ™åŒ¹é…: '{trigger}'",
                        "confidence": "high",
                        "estimated_tokens": skill_info["metadata"].get("estimated_tokens", 5000),
                        "from_cache": False
                    }

        return None

    def get_stats(self) -> Dict:
        total = self.rule_based_hits + self.claude_hits
        return {
            "rule_based_hits": self.rule_based_hits,
            "claude_hits": self.claude_hits,
            "rule_hit_rate": self.rule_based_hits / total if total > 0 else 0,
            "cost_saved": self.rule_based_hits * 0.001  # æ¯æ¬¡èŠ‚çœ $0.001
        }
```

**æ•ˆæœï¼š**
- è§„åˆ™å‘½ä¸­ç‡ï¼š20-30%
- é¢å¤–æˆæœ¬èŠ‚çœï¼š$60-90/æœˆï¼ˆåŸºäº 1ä¸‡æ¬¡/å¤©ï¼‰
- è§„åˆ™å‘½ä¸­æ—¶å“åº” < 50ms

### 4. æˆæœ¬ç›‘æ§ç³»ç»Ÿ

```python
from dataclasses import dataclass, field
from datetime import datetime
from typing import List, Dict
import json

@dataclass
class SkillRoutingRecord:
    """Skill è·¯ç”±è®°å½•"""
    timestamp: str
    user_query: str
    route_type: str  # "cache", "rule", "claude"
    loaded_skills: List[str]
    routing_cost_usd: float
    qa_cost_usd: float
    total_tokens: int
    cache_hit: bool

@dataclass
class SkillCostMonitor:
    """Skill æ–¹æ¡ˆæˆæœ¬ç›‘æ§"""
    budget_limit_usd: float = 100.0
    alert_threshold: float = 0.8

    routing_records: List[SkillRoutingRecord] = field(default_factory=list)
    total_cost_usd: float = 0.0

    def record_routing(
        self,
        user_query: str,
        route_type: str,
        loaded_skills: List[str],
        routing_cost_usd: float,
        qa_cost_usd: float,
        total_tokens: int,
        cache_hit: bool = False
    ):
        """è®°å½•è·¯ç”±ä½¿ç”¨"""
        record = SkillRoutingRecord(
            timestamp=datetime.now().isoformat(),
            user_query=user_query,
            route_type=route_type,
            loaded_skills=loaded_skills,
            routing_cost_usd=routing_cost_usd,
            qa_cost_usd=qa_cost_usd,
            total_tokens=total_tokens,
            cache_hit=cache_hit
        )

        self.routing_records.append(record)
        self.total_cost_usd += (routing_cost_usd + qa_cost_usd)

        # æ£€æŸ¥é¢„ç®—
        self._check_budget()

    def _check_budget(self):
        """æ£€æŸ¥é¢„ç®—"""
        usage_ratio = self.total_cost_usd / self.budget_limit_usd

        if usage_ratio >= 1.0:
            print(f"âš ï¸  é¢„ç®—å·²ç”¨å®Œï¼æ€»è´¹ç”¨: ${self.total_cost_usd:.2f}")
        elif usage_ratio >= self.alert_threshold:
            print(f"âš ï¸  é¢„ç®—è­¦å‘Šï¼å·²ä½¿ç”¨ {usage_ratio*100:.1f}%ï¼Œæ€»è´¹ç”¨: ${self.total_cost_usd:.2f}")

    def get_statistics(self) -> Dict:
        """è·å–ç»Ÿè®¡ä¿¡æ¯"""
        if not self.routing_records:
            return {}

        # æŒ‰è·¯ç”±ç±»å‹ç»Ÿè®¡
        route_type_stats = {}
        for record in self.routing_records:
            rt = record.route_type
            if rt not in route_type_stats:
                route_type_stats[rt] = {"count": 0, "total_cost": 0.0}
            route_type_stats[rt]["count"] += 1
            route_type_stats[rt]["total_cost"] += record.routing_cost_usd + record.qa_cost_usd

        # ç¼“å­˜å‘½ä¸­ç‡
        cache_hits = sum(1 for r in self.routing_records if r.cache_hit)
        cache_hit_rate = cache_hits / len(self.routing_records) if self.routing_records else 0

        # è·¯ç”±æˆæœ¬
        total_routing_cost = sum(r.routing_cost_usd for r in self.routing_records)
        total_qa_cost = sum(r.qa_cost_usd for r in self.routing_records)

        return {
            "total_requests": len(self.routing_records),
            "total_cost_usd": round(self.total_cost_usd, 4),
            "routing_cost_usd": round(total_routing_cost, 4),
            "qa_cost_usd": round(total_qa_cost, 4),
            "budget_usage_percent": round((self.total_cost_usd / self.budget_limit_usd) * 100, 2),
            "cache_hit_rate": round(cache_hit_rate * 100, 2),
            "route_type_breakdown": route_type_stats,
            "average_cost_per_request": round(self.total_cost_usd / len(self.routing_records), 6) if self.routing_records else 0
        }

    def export_report(self, output_file: str):
        """å¯¼å‡ºæŠ¥å‘Š"""
        stats = self.get_statistics()

        report = {
            "generated_at": datetime.now().isoformat(),
            "statistics": stats,
            "routing_records": [
                {
                    "timestamp": r.timestamp,
                    "user_query": r.user_query[:50],  # æˆªæ–­é•¿é—®é¢˜
                    "route_type": r.route_type,
                    "loaded_skills": r.loaded_skills,
                    "routing_cost_usd": r.routing_cost_usd,
                    "qa_cost_usd": r.qa_cost_usd,
                    "cache_hit": r.cache_hit
                }
                for r in self.routing_records
            ]
        }

        with open(output_file, "w", encoding="utf-8") as f:
            json.dump(report, f, ensure_ascii=False, indent=2)
```

## æµ‹è¯•éªŒè¯

### 1. ç¼“å­˜å‘½ä¸­ç‡æµ‹è¯•

```python
# åˆå§‹åŒ–
from redis import Redis
redis_client = Redis(host='localhost', port=6379, db=0)

router = CachedSkillRouter(
    skill_loader=skill_loader,
    api_key=CLAUDE_API_KEY,
    cache_backend="redis"
)

cost_monitor = SkillCostMonitor(budget_limit_usd=50.0)

# æµ‹è¯•ç›¸åŒé—®é¢˜çš„ç¼“å­˜
questions = ["è¨çœç¨ç‡æ˜¯å¤šå°‘ï¼Ÿ"] * 10  # é‡å¤10æ¬¡

for q in questions:
    result = router.route(q)

    # è®°å½•
    cost_monitor.record_routing(
        user_query=q,
        route_type="cache" if result.get("from_cache") else "claude",
        loaded_skills=[],
        routing_cost_usd=0.0 if result.get("from_cache") else 0.001,
        qa_cost_usd=0.0,
        total_tokens=0,
        cache_hit=result.get("from_cache", False)
    )

# æŸ¥çœ‹ç»Ÿè®¡
stats = cost_monitor.get_statistics()
print(f"ç¼“å­˜å‘½ä¸­ç‡: {stats['cache_hit_rate']}%")  # åº”è¯¥ > 50%
print(f"è·¯ç”±æˆæœ¬: ${stats['routing_cost_usd']}")  # åº”æ˜¾è‘—é™ä½
```

### 2. æ··åˆè·¯ç”±æ•ˆæœæµ‹è¯•

```python
hybrid_router = HybridRouter(skill_loader, cached_router)

test_questions = [
    "è¨çœç¨ç‡æ˜¯å¤šå°‘ï¼Ÿ",  # åº”å‘½ä¸­è§„åˆ™ï¼ˆ"è¨çœç¨ç‡" åœ¨ triggers ä¸­ï¼‰
    "Saskatchewan PST rate?",  # åº”å‘½ä¸­è§„åˆ™
    "æˆ‘æƒ³äº†è§£ç¨ç‡ç›¸å…³çš„çŸ¥è¯†",  # åº”ä½¿ç”¨ Claude è·¯ç”±
]

for q in test_questions:
    result = hybrid_router.route(q)
    print(f"é—®é¢˜: {q}")
    print(f"è·¯ç”±ç±»å‹: {result.get('reasoning', 'N/A')}\n")

# æŸ¥çœ‹ç»Ÿè®¡
stats = hybrid_router.get_stats()
print(f"è§„åˆ™å‘½ä¸­ç‡: {stats['rule_hit_rate']*100:.1f}%")
print(f"èŠ‚çœæˆæœ¬: ${stats['cost_saved']:.4f}")
```

### 3. ç«¯åˆ°ç«¯æˆæœ¬æµ‹è¯•

```python
# æ¨¡æ‹Ÿä¸€å¤©çš„æŸ¥è¯¢
daily_questions = ["è¨çœç¨ç‡æ˜¯å¤šå°‘ï¼Ÿ"] * 50 + ["RRSP é¢åº¦"] * 30 + ["å…¶ä»–é—®é¢˜"] * 20

for q in daily_questions:
    # è·¯ç”±
    result = hybrid_router.route(q)

    # æ¨¡æ‹Ÿé—®ç­”æˆæœ¬ï¼ˆå‡è®¾æ¯æ¬¡ $0.075ï¼‰
    qa_cost = 0.075 if result.get("primary_skills") else 0

    cost_monitor.record_routing(
        user_query=q,
        route_type=result.get("reasoning", "claude").split(":")[0],
        loaded_skills=[s["skill_id"] for s in result.get("primary_skills", [])],
        routing_cost_usd=0.0 if result.get("from_cache") else (0.0 if "è§„åˆ™" in result.get("reasoning", "") else 0.001),
        qa_cost_usd=qa_cost,
        total_tokens=15000,
        cache_hit=result.get("from_cache", False)
    )

# å¯¼å‡ºæŠ¥å‘Š
cost_monitor.export_report("daily_cost_report.json")

stats = cost_monitor.get_statistics()
print(f"æ€»è¯·æ±‚æ•°: {stats['total_requests']}")
print(f"æ€»æˆæœ¬: ${stats['total_cost_usd']}")
print(f"è·¯ç”±æˆæœ¬: ${stats['routing_cost_usd']}")
print(f"é—®ç­”æˆæœ¬: ${stats['qa_cost_usd']}")
print(f"ç¼“å­˜å‘½ä¸­ç‡: {stats['cache_hit_rate']}%")
print(f"å¹³å‡æ¯æ¬¡æˆæœ¬: ${stats['average_cost_per_request']}")
```

**é¢„æœŸç»“æœï¼š**
```
æ€»è¯·æ±‚æ•°: 100
æ€»æˆæœ¬: $4.50
è·¯ç”±æˆæœ¬: $0.02 (ç¼“å­˜å’Œè§„åˆ™èŠ‚çœäº†å¤§éƒ¨åˆ†)
é—®ç­”æˆæœ¬: $4.48
ç¼“å­˜å‘½ä¸­ç‡: 65%
å¹³å‡æ¯æ¬¡æˆæœ¬: $0.045
```

## æ³¨æ„äº‹é¡¹

**1. ç¼“å­˜ç­–ç•¥**
- **ç”Ÿäº§ç¯å¢ƒå¿…é¡»å¯ç”¨ Redis ç¼“å­˜**ï¼ˆå†…å­˜ç¼“å­˜åœ¨é‡å¯åä¸¢å¤±ï¼‰
- è®¾ç½®åˆç†çš„ TTLï¼ˆæ¨è 24 å°æ—¶ï¼‰
- å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜
- ç›‘æ§ Redis å†…å­˜ä½¿ç”¨

**2. è§„åˆ™åŒ¹é…æœ€ä½³å®è·µ**
- å®šæœŸåˆ†æé«˜é¢‘é—®é¢˜ï¼Œæ·»åŠ åˆ° triggers
- triggers åº”åŒ…å«ï¼š
  - æ ‡å‡†åç§°ï¼ˆå¦‚ "è¨çœç¨ç‡"ï¼‰
  - è‹±æ–‡åç§°ï¼ˆå¦‚ "Saskatchewan tax rate"ï¼‰
  - å¸¸è§ç¼©å†™ï¼ˆå¦‚ "SK tax"ï¼‰
- é¿å…è¿‡äºå®½æ³›çš„ triggersï¼ˆå¯èƒ½å¯¼è‡´è¯¯åŒ¹é…ï¼‰

**3. æˆæœ¬æ§åˆ¶**
- **è®¾ç½®é¢„ç®—ä¸Šé™å’Œå‘Šè­¦é˜ˆå€¼**
- å®æ—¶ç›‘æ§è·¯ç”±æˆæœ¬å’Œé—®ç­”æˆæœ¬
- å®šæœŸå®¡æŸ¥æˆæœ¬æŠ¥å‘Šï¼Œä¼˜åŒ–é«˜æˆæœ¬æŸ¥è¯¢
- è€ƒè™‘æŒ‰ç”¨æˆ·/ç§Ÿæˆ·è®¾ç½®é…é¢

**4. æ€§èƒ½ä¼˜åŒ–**
- Redis åº”ä¸åº”ç”¨æœåŠ¡å™¨åœ¨åŒä¸€æ•°æ®ä¸­å¿ƒï¼ˆå‡å°‘å»¶è¿Ÿï¼‰
- ç¼“å­˜é”®è®¡ç®—åº”é«˜æ•ˆï¼ˆMD5 å“ˆå¸Œï¼‰
- å®šæœŸç›‘æ§ç¼“å­˜å‘½ä¸­ç‡ï¼Œç›®æ ‡ > 50%
- å¦‚æœç¼“å­˜å‘½ä¸­ç‡ä½ï¼Œè€ƒè™‘ï¼š
  - å¢åŠ é¢„çƒ­é—®é¢˜
  - è°ƒé«˜è¯­ä¹‰ç›¸ä¼¼åº¦é˜ˆå€¼
  - ä¼˜åŒ– triggers è¦†ç›–åº¦

**5. ä¼˜åŒ–æ•ˆæœé¢„æœŸ**
| ä¼˜åŒ–ç­–ç•¥ | æˆæœ¬èŠ‚çœ | å“åº”æ—¶é—´æ”¹å–„ |
|---------|---------|------------|
| è·¯ç”±ç¼“å­˜ | 50-70% | 2s â†’ 10ms |
| é¢„çƒ­å¸¸è§é—®é¢˜ | é¢å¤– 10-20% | N/A |
| è¯­ä¹‰å»é‡ | é¢å¤– 5-10% | N/A |
| æ··åˆè·¯ç”± | é¢å¤– 20-30% | è·¯ç”±æ—¶é—´ < 50ms |
| **ç»¼åˆæ•ˆæœ** | **70-85%** | **æ˜¾è‘—** |

**6. ç›‘æ§æŒ‡æ ‡**
å¿…é¡»ç›‘æ§çš„å…³é”®æŒ‡æ ‡ï¼š
- ç¼“å­˜å‘½ä¸­ç‡
- è§„åˆ™è·¯ç”±å‘½ä¸­ç‡
- Claude è·¯ç”±è°ƒç”¨æ¬¡æ•°
- å¹³å‡æ¯æ¬¡è·¯ç”±æˆæœ¬
- å¹³å‡æ¯æ¬¡é—®ç­”æˆæœ¬
- æ€»æˆæœ¬è¶‹åŠ¿

## ä¾èµ–å…³ç³»

**å‰ç½®ä»»åŠ¡ï¼š**
- ä»»åŠ¡11ï¼šSkillLoaderï¼ˆæä¾› triggers ç”¨äºè§„åˆ™åŒ¹é…ï¼‰
- ä»»åŠ¡13ï¼šClaudeSkillRouterï¼ˆè·¯ç”±å¼•æ“ï¼‰
- ä»»åŠ¡14ï¼šSkillEngineï¼ˆç«¯åˆ°ç«¯é—®ç­”ï¼‰

**åç½®ä»»åŠ¡ï¼š**
- æ— ï¼ˆè¿™æ˜¯æœ€åçš„ä¼˜åŒ–ä»»åŠ¡ï¼‰
